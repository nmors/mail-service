<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/controllers/SendMailController.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="..\..\prettify.css" />
    <link rel="stylesheet" href="..\..\base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(..\..\sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="..\..\index.html">All files</a> / <a href="index.html">src/controllers</a> SendMailController.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">22.95% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>14/61</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">6.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>1/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">11.54% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>3/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">23.73% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>14/59</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import * as dotenv from 'dotenv';
dotenv.config();
&nbsp;
import * as bluebird from 'bluebird';
import * as express from 'express'; 
import * as mailgun from '../services/mailgun';
import * as sendgrid from '../services/sendgrid';
import fetch, { RequestInit, Response } from 'node-fetch';
import { logger } from '../logger';
import { MailService, Message } from '../models/MailService';
import firebase from '../database/firebase';
import { DataSnapshot } from '@firebase/database/dist/esm/src/api/DataSnapshot';
import { Reference } from '@firebase/database/dist/esm/src/api/Reference';
&nbsp;
export class SendMailController {
    private mailServices: MailService[];
&nbsp;
    /**
     * @param mailServices you can inject as many MailServices as you want here for extra reliability
     */
    constructor(
        ...mailServices: MailService[],
    ) {
        this.mailServices = [ ...mailServices ];
        this.listenForPendingEmails();
    }
&nbsp;
    /**
     * returns a new instance of the SendMailController with some MailServices injected.
     * bootstrap technique is used to provide an extra layer of dependency injection which makes writing unit tests easier
     *
     * @param fetchProvider http client library used to send mail - defaults to node-fetch if none specified
     */
    public static bootstrap(
        fetchProvider: any = fetch,
    ) {
        return new SendMailController(
            mailgun.createService(fetchProvider),
            sendgrid.createService(fetchProvider),
        );
    }
&nbsp;
    /**
     * Given a message to send, Returns a reducer function which can be applied to an array of MailServices.
     * The reducer will immediately return true if the previous service succesfully sent the message already.
     *
     * @param message the message that we should try to send
     */
    private getMailServiceReducer = <span class="fstat-no" title="function not covered" >(m</span>essage: Message) =&gt; <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(w</span>asSuccessful: boolean, mailService: MailService) =&gt;</span>
<span class="cstat-no" title="statement not covered" >        wasSuccessful || mailService.send(message)</span>
            .then(<span class="fstat-no" title="function not covered" >(s</span>endResult: any) =&gt; {
<span class="cstat-no" title="statement not covered" >                logger.info(`successfully sent your message with ${mailService.name}!`)</span>
<span class="cstat-no" title="statement not covered" >                return sendResult</span>
            })
            .catch(<span class="fstat-no" title="function not covered" >(e</span>rr: Error) =&gt; <span class="cstat-no" title="statement not covered" >logger.error(`There was an error sending with ${mailService.name}: ${err.message}` ))</span>
&nbsp;
    /**
     * Attempts to send the given message with all of the defined mailServices with reduce.
     * If all of the MailServices throws errors, the final return value will be undefined
     *
     * @param message the message that we should try to send (all services)
     */
    public <span class="fstat-no" title="function not covered" >async</span> sendMail(message: Message): Promise&lt;boolean&gt; {
        const sentMessage = <span class="cstat-no" title="statement not covered" >await bluebird.reduce(this.mailServices, this.getMailServiceReducer(message), false);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (!sentMessage) {</span>
<span class="cstat-no" title="statement not covered" >            logger.error(`we tried really hard, but all of our mail services (${this.mailServices.map(<span class="fstat-no" title="function not covered" >x </span>=&gt; <span class="cstat-no" title="statement not covered" >x.name)</span>}) refused to send our message!`);</span>
<span class="cstat-no" title="statement not covered" >            return false;</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return sentMessage;</span>
    }
&nbsp;
    /**
     * Returns an express Request handler (middleware) that can be applied to an API route.
     */
    public <span class="fstat-no" title="function not covered" >getMiddleware</span>(): express.RequestHandler {
<span class="cstat-no" title="statement not covered" >        return <span class="fstat-no" title="function not covered" >(r</span>eq: express.Request, res: express.Response) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >            logger.debug(req.body);</span>
            const emailsRef = <span class="cstat-no" title="statement not covered" >firebase.database().ref('/emails');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            emailsRef.push(Object.assign({}, req.body, {</span>
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
            }))
            .then(<span class="fstat-no" title="function not covered" >(e</span>mailSnapshot: DataSnapshot) =&gt; {
                const id = <span class="cstat-no" title="statement not covered" >emailSnapshot.key;</span>
<span class="cstat-no" title="statement not covered" >                res.json({</span>
                    id,
                    status: 'pending',
                });
            });
            // .catch((err: Error) =&gt; {
            //     res.status(500).json({
            //         message: 'failed to queue!'
            //     })
            // });
        };
    }
&nbsp;
    private listenForPendingEmails() {
        firebase.database()
            .ref('/emails')
            .orderByChild('status')
            .equalTo('pending')
            .orderByPriority()
            .on('child_added', <span class="fstat-no" title="function not covered" >(e</span>mailSnapshot: DataSnapshot | any) =&gt; {
<span class="cstat-no" title="statement not covered" >                if (!emailSnapshot) {</span>
<span class="cstat-no" title="statement not covered" >                    return logger.debug('could not get pending emails!');</span>
                }
                const emailReference: Reference = <span class="cstat-no" title="statement not covered" >emailSnapshot.ref;</span>
                const message: Message = <span class="cstat-no" title="statement not covered" >{</span>
                    to: emailSnapshot.val().to,
                    from: emailSnapshot.val().from,
                    subject: emailSnapshot.val().subject,
                    text: emailSnapshot.val().text,
                }
&nbsp;
<span class="cstat-no" title="statement not covered" >                logger.debug('listening for attempts...')</span>
<span class="cstat-no" title="statement not covered" >                this.listenForAttempt(emailReference, message);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                logger.debug('creating new attempt');</span>
<span class="cstat-no" title="statement not covered" >                this.createNewAttempt(emailReference);</span>
<span class="cstat-no" title="statement not covered" >                return;</span>
            })
    }
&nbsp;
    // Update the attempt count. This is probably not really needed! remove?
    private <span class="fstat-no" title="function not covered" >updateAttemptCount</span>(emailRef: Reference) {
<span class="cstat-no" title="statement not covered" >        emailRef.transaction(<span class="fstat-no" title="function not covered" >function(</span>email: any) {</span>
<span class="cstat-no" title="statement not covered" >          if (email) {</span>
<span class="cstat-no" title="statement not covered" >            email.attemptCount = email.attempts ? Object.keys(email.attempts).length : 0;</span>
          }
<span class="cstat-no" title="statement not covered" >          return email;</span>
        });
    }
&nbsp;
    private <span class="fstat-no" title="function not covered" >setStatus</span>(ref: Reference, status: string) {
<span class="cstat-no" title="statement not covered" >        ref.transaction(<span class="fstat-no" title="function not covered" >function(</span>obj: any) {</span>
<span class="cstat-no" title="statement not covered" >            if (obj) {</span>
<span class="cstat-no" title="statement not covered" >                obj.status = status;</span>
            }
<span class="cstat-no" title="statement not covered" >            return obj;</span>
        });
    }
&nbsp;
    private <span class="fstat-no" title="function not covered" >listenForAttempt</span>(emailReference: Reference, message: Message) {
<span class="cstat-no" title="statement not covered" >        emailReference</span>
            .child('attempts')
            .orderByChild('status')
            .equalTo('pending')
            .on('child_added', <span class="fstat-no" title="function not covered" >(a</span>ttemptSnapshot: DataSnapshot) =&gt; {
<span class="cstat-no" title="statement not covered" >                this.sendMail(message)</span>
                    .then(<span class="fstat-no" title="function not covered" >sendMailResult</span> =&gt; {
<span class="cstat-no" title="statement not covered" >                        if (sendMailResult) {</span>
<span class="cstat-no" title="statement not covered" >                            this.setStatus(attemptSnapshot.ref, 'success');</span>
<span class="cstat-no" title="statement not covered" >                            this.setStatus(emailReference, 'success');</span>
                        } else {
<span class="cstat-no" title="statement not covered" >                            this.setStatus(attemptSnapshot.ref, 'failed');</span>
                        }
                    }).catch(<span class="fstat-no" title="function not covered" >err</span> =&gt; {
&nbsp;
                    })
<span class="cstat-no" title="statement not covered" >                    logger.debug('detected new attempt');</span>
<span class="cstat-no" title="statement not covered" >                    logger.debug('set status to success!');</span>
            },
<span class="fstat-no" title="function not covered" >            (e</span>rror: Error) =&gt; <span class="cstat-no" title="statement not covered" >logger.debug('failed to add attempt listener')</span>
        );
    }
&nbsp;
    private <span class="fstat-no" title="function not covered" >createNewAttempt</span>(emailReference: Reference) {
        // Create a new attempt
<span class="cstat-no" title="statement not covered" >        emailReference</span>
            .child('attempts')
            .push({
                provider: 'mailgrid',
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
            })
            .then(<span class="fstat-no" title="function not covered" >({</span>key}: DataSnapshot) =&gt; {});
&nbsp;
        // Update the attempt count. This is probably not really needed!
<span class="cstat-no" title="statement not covered" >        emailReference</span>
            .child('attempts').on('value',
<span class="fstat-no" title="function not covered" >            (d</span>ataSnapshot: DataSnapshot) =&gt; <span class="cstat-no" title="statement not covered" >this.updateAttemptCount(emailReference),</span>
<span class="fstat-no" title="function not covered" >            (e</span>rror: Error) =&gt; <span class="cstat-no" title="statement not covered" >logger.debug('failed to update attempt count'),</span>
        );
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Wed Jan 10 2018 11:10:36 GMT+1100 (AUS Eastern Daylight Time)
</div>
</div>
<script src="..\..\prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="..\..\sorter.js"></script>
</body>
</html>
